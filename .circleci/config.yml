version: 2
jobs:
  build:
    docker:
      - image: circleci/node:7.10

    working_directory: ~/jagonzalr

    steps:
      - checkout            

      - run:
          name: install python dependencies
          command: |
            sudo apt-get update
            sudo apt-get install ruby-full
            sudo apt-get install python-dev --fix-missing
            sudo apt-get install libfontconfig
            sudo apt-get -y install python-pip
            sudo pip install six --upgrade
            sudo pip install blessed --upgrade
            sudo pip install awscli --upgrade

      - restore_cache:
          keys:
            - v0.0.3-{{ checksum "package.json" }}
            - v0.0.3-

      - run:
          name: NPM Install
          command: npm install

      - save_cache:
          key: v0.0.3-{{ checksum "package.json" }}
          paths:
            - node_modules/

      - deploy:
          name: Deploy to S3 and Cloudfront
          command: |
            npm run build
            python fix.py
            aws s3 sync $DIST s3://$AWS_BUCKET/ --delete
            aws cloudfront create-invalidation --cli-input-json '{"DistributionId":"'"$AWS_CLOUDFRONT_ID"'","InvalidationBatch":{"Paths":{"Quantity":2,"Items":["/index.html","/*"]},"CallerReference": "'$(date "+%s")'"}}'